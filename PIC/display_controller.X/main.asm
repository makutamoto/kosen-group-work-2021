	LIST	P=PIC16F648A
	INCLUDE	<P16F648A.INC>
	__CONFIG 	_CP_OFF & _MCLRE_OFF & _PWRTE_OFF & _WDT_OFF & _HS_OSC & _LVP_OFF & _BOREN_OFF    

; Pin definitions
;PORTB
MASTER_BUSY	EQU		H'05'
	
; ALL BANK
ARG0		EQU		H'70'
ARG1		EQU		H'71'
TEMP0		EQU		H'72'
TEMP1		EQU		H'73'

		ORG		H'0000'
INIT		
		MOVLW		H'07'
		MOVWF		CMCON
		BSF		STATUS,RP0
		CLRF		TRISA
		MOVLW		B'00000110'
		MOVWF		TRISB
		MOVLW		H'3F'
		MOVWF		PR2
		
		MOVLW		B'11010111'
		MOVWF		OPTION_REG
		
		BCF		STATUS, RP0
		CLRF		PORTA
		MOVLW		B'00100000'
		MOVWF		PORTB
		
		CLRF		TMR0
		
		MOVLW		B'00001100'
		IORWF		CCP1CON
		
		BSF		T2CON, TMR2ON
		MOVLW		H'0F'
		MOVWF		CCPR1L
		
		MOVLW		B'11000000'
		IORWF		INTCON, F
		
		BSF		RCSTA, SPEN
		BSF		STATUS, RP0
		BCF		TXSTA, SYNC
		BSF		TXSTA, BRGH
		CLRF		SPBRG
		BSF		TXSTA, TXEN
		BCF		STATUS, RP0
		BSF		RCSTA, CREN
		
		GOTO		START

SEND_COMMAND	; ARG0: address, ARG1: command
		BTFSS		PIR1, RCIF
		GOTO		$ - 1
		BCF		RCSTA, CREN
		MOVFW		RCREG
		MOVFW		RCREG
		BCF		PORTB, MASTER_BUSY
		MOVFW		ARG0
		MOVWF		TXREG
		MOVFW		ARG1
		MOVWF		TXREG
		BSF		STATUS, RP0
		BTFSS		TXSTA, TRMT
		GOTO		$ - 1
		BCF		STATUS, RP0
		BSF		RCSTA, CREN
		BSF		PORTB, MASTER_BUSY
		RETURN
		
START
		MOVLW		H'00'
		MOVWF		ARG0
		MOVLW		H'01'
		MOVWF		ARG1
		CALL		SEND_COMMAND
		
		CLRF		TEMP0
		CLRF		TEMP1
LOOP
		BTFSS		INTCON, T0IF
		GOTO		$ - 1
		BCF		INTCON, T0IF
		
		MOVLW		H'01'
		ADDWF		TEMP0, F
		MOVLW		D'40'
		SUBWF		TEMP0, W
		BTFSC		STATUS, Z
		CLRF		TEMP0
		
		MOVLW		H'01'
		ADDWF		TEMP1, F
		MOVLW		D'10'
		SUBWF		TEMP1, W
		BTFSC		STATUS, Z
		CLRF		TEMP1
		
		MOVLW		D'80'
		MOVWF		ARG0
		MOVFW		TEMP0
		SUBLW		H'00'
		MOVWF		ARG1
		CALL		SEND_COMMAND
		
		MOVLW		D'81'
		MOVWF		ARG0
		MOVFW		TEMP1
		MOVWF		ARG1
		CALL		SEND_COMMAND
		GOTO		LOOP

NOP10CYCLES	NOP
		NOP
		NOP
		NOP
		NOP
		NOP
		RETURN
		
		END
