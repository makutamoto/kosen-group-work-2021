	LIST	P=PIC16F648A
	INCLUDE	<P16F648A.INC>
	__CONFIG 	_CP_OFF & _MCLRE_OFF & _PWRTE_OFF & _WDT_OFF & _HS_OSC & _LVP_OFF & _BOREN_OFF    

; Pin definitions
;PORTB
GUN_COM		EQU		H'00'
MASTER_BUSY	EQU		H'05'
	
; bank 0
STATUS_TEMP	EQU		H'20'
GUN_CURRENT	EQU		H'21'
GUN_CURRENT_BIT	EQU		H'22'
GUN_X_TEMP	EQU		H'23'
GUN_Y_TEMP	EQU		H'24'
GUN_FLAGS_TEMP	EQU		H'25'
GUN_X		EQU		H'26'
GUN_Y		EQU		H'27'
GUN_FLAGS	EQU		H'28'
INT_FSR_BACK	EQU		H'29'
	
; ALL BANK
ARG0		EQU		H'70'
ARG1		EQU		H'71'
TEMP0		EQU		H'72'
TEMP1		EQU		H'73'
W_TEMP		EQU		H'74'
		
		ORG		H'0000'
		GOTO		INIT

		ORG		H'0004'
INTERRUPT
		MOVWF		W_TEMP
		SWAPF		STATUS, W
		BCF		STATUS, RP0
		MOVWF		STATUS_TEMP
		
		BTFSC		INTCON, T0IF
		GOTO		TMR0_MATCH
		BTFSC		INTCON, INTF
		GOTO		INT_MATCH
		GOTO		INTERRUPT_END
TMR0_MATCH
		BTFSS		INTCON, INTE
		GOTO		TMR0_MATCH_MAIN
		BTFSS		INTCON, INTF
		GOTO		TMR0_MATCH_MAIN
		GOTO		INT_MATCH
TMR0_MATCH_MAIN
		;MOVFW		GUN_CURRENT_BIT
		;MOVWF		TXREG
		;BSF		STATUS, RP0
		;BTFSS		TXSTA, TRMT
		;GOTO		$ - 1
		;BCF		STATUS, RP0
		
		
		MOVFW		FSR
		MOVWF		INT_FSR_BACK
		
		MOVLW		GUN_X_TEMP
		MOVWF		FSR
		MOVFW		GUN_CURRENT
		ADDWF		FSR, F
		
		RLF		INDF, F
		
		BSF		INDF, 0
		BTFSS		PORTB, GUN_COM
		BCF		INDF, 0
		
		MOVFW		INT_FSR_BACK
		MOVWF		FSR
		
		DECFSZ		GUN_CURRENT_BIT, F
		GOTO		TMR0_MATCH_END
		MOVLW		H'08'
		MOVWF		GUN_CURRENT_BIT
		INCF		GUN_CURRENT, F
		MOVLW		H'03'
		SUBWF		GUN_CURRENT, W
		BTFSS		STATUS, Z
		GOTO		TMR0_MATCH_END
		
		MOVFW		GUN_X_TEMP
		MOVWF		GUN_X
		MOVFW		GUN_Y_TEMP
		MOVWF		GUN_Y
		MOVFW		GUN_FLAGS_TEMP
		MOVWF		GUN_FLAGS
		
		BSF		INTCON, INTE
		BCF		INTCON, T0IE
TMR0_MATCH_END
		CLRF		TMR0
		BCF		INTCON, T0IF
		BCF		INTCON, INTF
		GOTO		INTERRUPT_END
INT_MATCH	
		CLRF		GUN_CURRENT
		MOVLW		H'08'
		MOVWF		GUN_CURRENT_BIT
		
		CLRF		TMR0
		BSF		INTCON, T0IE
		BCF		INTCON, T0IF
		
		BCF		INTCON, INTF
		BCF		INTCON, INTE
		
		GOTO		INTERRUPT_END
INTERRUPT_END
		SWAPF		STATUS_TEMP, W
		MOVWF		STATUS
		SWAPF		W_TEMP, F
		SWAPF		W_TEMP, W
		
		RETFIE

INIT		
		MOVLW		H'07'
		MOVWF		CMCON
		BSF		STATUS,RP0
		CLRF		TRISA
		MOVLW		B'00000111'
		MOVWF		TRISB
		MOVLW		H'3F'
		MOVWF		PR2
		
		MOVLW		B'10010010'
		MOVWF		OPTION_REG
		
		BCF		STATUS, RP0
		CLRF		PORTA
		MOVLW		B'00100000'
		MOVWF		PORTB
		
		CLRF		TMR0
		
		MOVLW		B'00000001'
		MOVWF		T1CON
		
		MOVLW		B'00001100'
		IORWF		CCP1CON
		
		BSF		T2CON, TMR2ON
		MOVLW		H'0F'
		MOVWF		CCPR1L
		
		MOVLW		B'10010000'
		MOVWF		INTCON
		
		BSF		RCSTA, SPEN
		BSF		STATUS, RP0
		BCF		TXSTA, SYNC
		BSF		TXSTA, BRGH
		CLRF		SPBRG
		BSF		TXSTA, TXEN
		BCF		STATUS, RP0
		BSF		RCSTA, CREN
		
		CLRF		GUN_X
		CLRF		GUN_Y
		CLRF		GUN_FLAGS
		
		GOTO		START

SEND_COMMAND	; ARG0: address, ARG1: command
		BTFSS		PIR1, RCIF
		GOTO		$ - 1
		BCF		RCSTA, CREN
		MOVFW		RCREG
		MOVFW		RCREG
		BCF		PORTB, MASTER_BUSY
		MOVFW		ARG0
		MOVWF		TXREG
		MOVFW		ARG1
		MOVWF		TXREG
		BSF		STATUS, RP0
		BTFSS		TXSTA, TRMT
		GOTO		$ - 1
		BCF		STATUS, RP0
		BSF		RCSTA, CREN
		BSF		PORTB, MASTER_BUSY
		RETURN
		
START	
		MOVLW		H'00'
		MOVWF		ARG0
		MOVLW		H'01'
		MOVWF		ARG1
		CALL		SEND_COMMAND
LOOP
		MOVFW		GUN_Y
		MOVWF		TXREG
		MOVFW		GUN_X
		MOVWF		TXREG
		BSF		STATUS, RP0
		BTFSS		TXSTA, TRMT
		GOTO		$ - 1
		BCF		STATUS, RP0
		GOTO		LOOP
		
		
		BTFSS		PIR1, TMR1IF
		GOTO		$ - 1
		BCF		PIR1, TMR1IF
		
		MOVLW		D'80'
		MOVWF		ARG0
		MOVFW		GUN_Y
		SUBLW		H'00'
		MOVWF		ARG1
		CALL		SEND_COMMAND
		
		MOVLW		D'81'
		MOVWF		ARG0
		MOVFW		GUN_X
		MOVWF		ARG1
		CALL		SEND_COMMAND
		GOTO		LOOP

NOP10CYCLES	NOP
		NOP
		NOP
		NOP
		NOP
		NOP
		RETURN
		
		END
